<!DOCTYPE html>
<meta charset="utf-8">
<title>Streamgraph</title>
<style>
button {
  position: absolute;
  right: 10px;
  top: 10px;
}
</style>
<html>
<body>
	<svg id="graph">
	</svg>
	<button onclick="transition()">Update</button>
</body>
</html>
<script>
	var n = 20, // number of layers
		m = 200; // number of samples per layer
	var arr = [];
	for(var i = 0; i < n; i++){
		arr.push(i);
	}
	var dataset = stack(arr.map(function(){ return bumpLayer(m); }));
	var w = 1200,
		h = 600;
	var wunit = w / m,
		hunit = h / (getMax(dataset[dataset.length-1]) - getMin(dataset[0]));
	var svg = document.getElementById("graph");
	svg.setAttribute("width", w);
	svg.setAttribute("height", h);
	for(var i = 0; i < n; i++){
		var path = document.createElementNS("http://www.w3.org/2000/svg","path");
		var str = genPath(dataset[i],dataset[i+1], wunit, hunit, h);
		var r = Math.floor((i+1)/n*100) + 100;
		var g = Math.floor((i+1)/n*100) + 100;
		var b = Math.floor((i+1)/n*100) + 150;
		path.setAttribute("fill", "rgb(" + r + "," + g + "," + b + ")");
		path.setAttribute("stroke", "gray");
		path.setAttribute("stroke-width", "0px");
		path.setAttribute("d", str);
		svg.appendChild(path);
	}
function stack(data){
	var arr = [[]];
	for(var i = 0; i < data[0].length; i++){
		arr[0].push({x:data[0][i].x, y:data[0][i].y});
	}
	for(var i = 1; i < data.length; i++){
		for(var j = 0; j < data[i].length; j++){
			arr[0][j].y += data[i][j].y;
		}
	}
	for(var i = 0; i < arr[0].length; i++){
		arr[0][i].y *= -0.5;
	}
	for(var i = 0; i < data.length; i++){
		arr.push([]);
		for(var j = 0; j < data[i].length; j++){
			arr[arr.length - 1].push({x:data[i][j].x, y:data[i][j].y+arr[arr.length - 2][j].y});
		}
	}
	return arr;
}
function transition() {
	while(svg.getElementsByTagName("path")[0]){
		svg.removeChild(svg.getElementsByTagName("path")[0]);
	}
	dataset = stack(arr.map(function(){ return bumpLayer(m); }));
	hunit = h / (getMax(dataset[dataset.length-1]) - getMin(dataset[0]));
	for(var i = 0; i < n; i++){
		var path = document.createElementNS("http://www.w3.org/2000/svg","path");
		var str = genPath(dataset[i],dataset[i+1], wunit, hunit, h);
		var r = Math.floor((i+1)/n*100) + 100;
		var g = Math.floor((i+1)/n*100) + 100;
		var b = Math.floor((i+1)/n*100) + 150;
		path.setAttribute("fill", "rgb(" + r + "," + g + "," + b + ")");
		path.setAttribute("stroke", "gray");
		path.setAttribute("stroke-width", "0px");
		path.setAttribute("d", str);
		svg.appendChild(path);
	}
}
function genPath(g0, g1, wunit, hunit, h){
	var str = "M" + g1[0].x * wunit + "," + (g1[0].y * hunit + h/2);
	for(var i = 1; i < g1.length; i++){
		str += "L" + g1[i].x * wunit + "," + (g1[i].y * hunit + h/2);
	}
	for(var i = g0.length - 1; i >= 0; i--){
		str += "L" + g0[i].x * wunit + "," + (g0[i].y * hunit + h/2);
	}
	return str;
}

// Inspired by Lee Byron's test data generator.
function bumpLayer(n) {

  function bump(a) {
    var x = 1 / (.1 + Math.random()),
        y = 2 * Math.random() - .5,
        z = 10 / (.1 + Math.random());
    for (var i = 0; i < n; i++) {
      var w = (i / n - y) * z;
      a[i] += x * Math.exp(-w * w);
    }
  }

  var a = [], i;
  for (i = 0; i < n; ++i) a[i] = 0;
  for (i = 0; i < 5; ++i) bump(a);
  return a.map(function(d, i) { return {x: i, y: Math.max(0, d)}; });
}

function getMax(layer){
	var max = -99999;
	for(var i = 0; i < layer.length; i++){
		if(max < layer[i].y){
			max = layer[i].y;
		}	
	}
	return max;
}
function getMin(layer){
	var min = 99999;
	for(var i = 0; i < layer.length; i++){
		if(min > layer[i].y){
			min = layer[i].y;
		}
	}
	return min;
}
function getIntegral(layer){
	var sum = (layer[0].y + layer[layer.length - 1].y) / 2;
	for(var i = 1; i < layer.length - 1; i++){
		sum += layer[i].y;
	}
	return sum;
}
function resort(data){
	
}
</script>